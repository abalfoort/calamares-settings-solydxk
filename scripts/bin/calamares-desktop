#!/bin/bash
# Creates an "Install SolydXK" icon on the live session tested with:
# Xfce, LXDE, LXqt, Gnome, KDE, Mate, Cinnamon

# We query xdg-user-dir because the Desktop directory has different
# names for different languages
DESKTOP=$(xdg-user-dir DESKTOP)

# Create ~/Desktop just in case this runs before the xdg folder
# creation script.
mkdir -p "$DESKTOP"

# Copy a .desktop file to the desktop
function copy_desktop() {
    ORG=$1
    DEST="$DESKTOP/$(basename $ORG)"

    cp "$ORG" "$DEST"
    chmod g+w,a+x "$DEST"
    # Xfce: prevent Untrusted Application Launcher dialog
    gio set -t string "$DEST" metadata::xfce-exe-checksum $(sha256sum "$DEST" | awk '{print $1}')
    gio set -t string "$DEST" metadata::trust "true"
}

function copy_w95() {
    DT_W95=$(ls /usr/share/calamares-settings-solydxk/w95/*.desktop)
    for DT in $DT_W95; do
        copy_desktop "$DT"
    done
}

# Among the SolydXK desktop environments, LXDE is the only one
# that behaves completely different.
if [ -f /usr/bin/lxsession ]; then
    cat > "$DESKTOP/install-solydxk.desktop" << EOF
[Desktop Entry]
Type=Link
Name=Install SolydXK
Icon=install-solydxk
URL=/usr/share/applications/install-solydxk.desktop
EOF
else
    copy_desktop "/usr/share/applications/install-solydxk.desktop"
fi

# Change desktop on certain dates
CUR_DATE=$(date +%m%d)
# Desktop specific
DT=${XDG_CURRENT_DESKTOP:0:1}
DT=${DT,,}
BG="/usr/share/calamares-settings-solydxk/${CUR_DATE}-${DT}.png"
if [ ! -e "$BG" ]; then
    BG="/usr/share/calamares-settings-solydxk/${CUR_DATE}-a.png"
fi
if [ ! -e "$BG" ]; then
    exit 0
fi

if [ ! -z "$(which plasma-apply-wallpaperimage)" ]; then
    # KDE Plasma
    plasma-apply-wallpaperimage "$BG"
    [ $CUR_DATE == 0401 ] && copy_w95
elif [ ! -z "$(which pcmanfm-qt)" ]; then
    # Lxqt
    pcmanfm-qt --set-wallpaper "$BG" --wallpaper-mode=stretch
elif [ ! -z "$(which xfconf-query)" ]; then
    # Xfce4
    # Loop through all the monitors
    # and set the background image
    PROPS=$(xfconf-query -c xfce4-desktop -l | grep "workspace0/last-image")
    for PROP in $PROPS; do
        xfconf-query --channel xfce4-desktop --property $PROP --set "$BG"
        xfconf-query --channel xfce4-desktop --property ${PROP%/*}/image-style --set 3
    done
    [ $CUR_DATE == 0401 ] && copy_w95
fi
